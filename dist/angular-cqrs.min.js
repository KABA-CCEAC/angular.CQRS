// angular.CQRS, v0.1.3
// Copyright (c)2014 KABA-CCEAC.

angular.module("ngCQRS",[]),angular.module("ngCQRS").provider("CQRS",function(){function a(a){if("function"!=typeof a)throw"Please specify a valid function!"}var b=function(){throw"Please specify a urlFactory for CQRS queries. CQRSProvider.setUrlFactory(function (viewModelName) { .... }"},c=function(a){return a},d=function(a){return a},e=function(a){return a.commandId};this.setCommandIdExtractionFunction=function(b){a(b),e=b},this.setUrlFactory=function(c){a(c),b=c},this.setQueryParser=function(b){a(b),c=b},this.setEventParser=function(b){a(b),d=b},this.toUrlGETParameterString=function(a){var b=[];return angular.forEach(a,function(a,c){b.push(c+"="+a)}),"?"+b.join("&")},this.$get=["$q","$rootScope","$http","ObjectId",function(a,f,g,h){function i(d,e){var f=a.defer();return g.get(b(d,e)).success(function(a){f.resolve(c(a))}).error(function(a,b){f.reject({data:a,status:b})}),f.promise}function j(a){return angular.isUndefined(a.id)&&(a.id=h().toString()),a}function k(a,b){if(!angular.isUndefined(b)){if("function"!=typeof b)throw"Please specify a valid callback function...";r[a]=b}}function l(a,b){s[a]=b}function m(a){var b=e(a),c=r[b];angular.isDefined(c)&&(c(a),r[b]=void 0);var d=s[b];angular.isDefined(d)&&(d.resolve(a),s[b]=void 0)}function n(b,c){var d=j(b);f.$emit("CQRS:commands",d),k(d.id,c);var e=a.defer();return l(d.id,e),e.promise}function o(a){f.$on("CQRS:events",function(b,c){var e=d(c);m(e),a(e)})}function p(a){f.$emit("CQRS:events",a)}function q(a){f.$on("CQRS:commands",function(b,c){a(c)})}var r={},s={};return{query:i,sendCommand:n,onEvent:o,onCommand:q,eventReceived:p}}]}),angular.module("ngCQRS").service("DenormalizationService",function(){function a(a,b){return angular.isUndefined(b)&&(b="_common"),angular.isUndefined(c[b])?{}:angular.isUndefined(c[b][a])?{}:c[b][a]}function b(a,b){if(angular.isUndefined(a.aggregateType)&&(a.aggregateType="_common"),angular.isUndefined(c[a.aggregateType])&&(c[a.aggregateType]={}),angular.isUndefined(c[a.aggregateType][a.eventName])&&(c[a.aggregateType][a.eventName]={}),angular.isDefined(c[a.aggregateType][a.eventName][a.viewModelName]))throw'Denormalizer function for viewModelName "'+a.viewModelName+'", aggregateType: "'+a.aggregateType+'" and eventName "'+a.eventName+'" already defined.';c[a.aggregateType][a.eventName][a.viewModelName]=b}var c={};return{getDenormalizerFunctions:a,registerDenormalizerFunction:b}}),angular.module("ngCQRS").service("ObjectId",function a(){function b(){var a="tenac";try{return window.localStorage.setItem(a,a),window.localStorage.removeItem(a),!0}catch(b){return!1}}function a(){return this instanceof a?void("string"==typeof arguments[0]&&24===arguments[0].length?(this.timestamp=Number("0x"+arguments[0].substr(0,8)),this.machine=Number("0x"+arguments[0].substr(8,6)),this.pid=Number("0x"+arguments[0].substr(14,4)),this.increment=Number("0x"+arguments[0].substr(18,6))):4===arguments.length&&angular.isDefined(arguments[0])&&angular.isDefined(arguments[1])&&angular.isDefined(arguments[2])&&angular.isDefined(arguments[3])?(this.timestamp=arguments[0],this.machine=arguments[1],this.pid=arguments[2],this.increment=arguments[3]):(this.timestamp=Math.floor((new Date).valueOf()/1e3),this.machine=e,this.pid=d,this.increment=c++,c>16777215&&(c=0))):new a(arguments[0],arguments[1],arguments[2],arguments[3])}var c=0,d=Math.floor(32767*Math.random()),e=Math.floor(16777216*Math.random());if(b()){var f=parseInt(window.localStorage.mongoMachineId);f>=0&&16777215>=f&&(e=Math.floor(window.localStorage.mongoMachineId)),window.localStorage.mongoMachineId=e,window.document.cookie="mongoMachineId="+e+";expires=Tue, 19 Jan 2038 05:00:00 GMT"}else{var g=window.document.cookie.split("; ");for(var h in g){var i=g[h].split("=");if("mongoMachineId"===i[0]&&i[1]>=0&&i[1]<=16777215){e=i[1];break}}window.document.cookie="mongoMachineId="+e+";expires=Tue, 19 Jan 2038 05:00:00 GMT"}return a.prototype.getDate=function(){return new Date(1e3*this.timestamp)},a.prototype.toArray=function(){var a,b=this.toString(),c=[];for(a=0;12>a;a++)c[a]=parseInt(b.slice(2*a,2*a+2),16);return c},a.prototype.toString=function(){var a=this.timestamp.toString(16),b=this.machine.toString(16),c=this.pid.toString(16),d=this.increment.toString(16);return"00000000".substr(0,8-a.length)+a+"000000".substr(0,6-b.length)+b+"0000".substr(0,4-c.length)+c+"000000".substr(0,6-d.length)+d},a}),angular.module("ngCQRS").service("StoreService",["$rootScope","$q","$filter","$timeout","CQRS","DenormalizationService",function(a,b,c,d,e,f){function g(a){return angular.isDefined(a.payload)&&angular.isDefined(a.name)}function h(){e.onEvent(function(b){if(g(b)){var c=f.getDenormalizerFunctions(b.name,b.aggregateType);angular.forEach(c,function(a,c){var d=p[c];angular.isDefined(d)&&(d.data=a(d.data,b.payload,b),d.callbacks.forEach(function(a){a.callbackFunction(d.data)}))}),a.$apply()}})}function i(a,b,c){if(angular.isUndefined(b)||"object"!=typeof b)throw"Please provide a valid parameters object!";if(angular.isUndefined(a)||"string"!=typeof a)throw"Please provide a valid model Name (string)!";if(angular.isUndefined(c)||"function"!=typeof c)throw"Please provide a valid callback function!"}function j(a,b,c,d){angular.isDefined(p[b])?(p[b].callbacks.push({callbackFunction:c,scopeId:d}),p[b].data=a):p[b]={data:a,callbacks:[{callbackFunction:c,scopeId:d}]},c(a)}function k(a,b){b(a.data,a.status)}function l(a){var b=[];angular.forEach(p,function(d,e){var f=c("filter")(d.callbacks,function(b){return b.scopeId!==a.$id});f.length<1?b.push(e):d.callbacks=f}),b.forEach(function(a){delete p[a]})}function m(a,b,c,d,f){i(a,b,c);var g=e.query(a,b);g.then(function(b){j(b,a,c,f)},function(a){k(a,d)})}function n(a){return a.$on("$destroy",function(a){l(a.currentScope)}),new q(a.$id)}function o(){return new q(void 0)}var p={};h();var q=function(a){this.for=function(a,b){return this.viewModelName=a,this.parameters=b||{},this},this.do=function(b,c){m(this.viewModelName,this.parameters,b,c,a)}};return{createForController:n,createForService:o}}]);